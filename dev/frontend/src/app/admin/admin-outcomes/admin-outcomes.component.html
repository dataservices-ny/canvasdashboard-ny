<ng-template #spinner>
    <div *ngIf="current_grade$ | async" class="d-flex justify-content-left">
      <div class="spinner-border spinner-border-large" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
</ng-template>

<div *ngIf="(filtered_students$ | async) && !(listUpdating$ | async); else spinner">
    <div class="form-check pb-2">
        <input class="form-check-input" type="checkbox" id="showUnassessed" (change)="updateShowUnassessed($event.target.checked)">
        <label class="form-check-label" for="showAllOutcomes">
          Show unassessed outcomes
        </label>
    </div>

    <div class="table-container">
        <table class="table table-hover table-bordered table-fixed-header rotated-header">
            <thead>
                <tr>
                    <th>Student</th>
                    <th class="loading">
                        <div class="rotated-header-container">
                            <div class="rotated-header-content small text-truncate d-inline-flex align-items-center">
                                Loaded?
                            </div>
                        </div>
                    </th>
                    <th>
                        <div class="rotated-header-container">
                            <div class="rotated-header-content small text-truncate d-inline-flex align-items-center">
                                Outcome Proficiency
                            </div>
                        </div>
                    </th>
                    <ng-container *ngFor="let course of all_outcomes | keyvalue">
                        <th *ngFor="let outcome of course.value | keyvalue | sortBy:'asc':'value'" [hidden]="!all_outcomes[course.key][outcome.key].has_assessments && !showUnassessed">
                            <div class="rotated-header-container">
                                <div class="rotated-header-content small text-truncate d-inline-flex align-items-center text-truncate">
                                    {{ (dataService.getCourse(course.key) | async).course_name }}<br/>
                                    {{ outcome.value.title }}
                                </div>
                            </div>
                        </th>
                    </ng-container>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let student of filtered_students$ | async | keyvalue | sortBy:'asc':'value.sortable_name'">
                
                    <td class="student-col text-truncate align-middle">
                        <a [routerLink]="['/', 'dashboard', 'student', student.value.id]" class="text-link" target="_blank">{{ student.value.name }} ({{ student.value.grade }})</a>
                    </td>

                    <td class="loading align-middle">
                        <div class="text-center">
                            <span>
                                <div *ngIf="!student_courses_loaded || adminService.coursesLoading(student.value.courses); else loaded" class="spinner-grow spinner-grow-sm" role="status"></div>
                                <div class="text-center align-items-center">
                                    <div class="text-center">
                                        <ng-template #loaded>
                                            <icon-check></icon-check>
                                        </ng-template>
                                    </div>
                                </div>
                            </span>
                        </div>
                    </td>

                    <td class="align-middle">
                        <div *ngIf="student.value.percent_proficient_advanced != null" class="text-center">
                            <strong>{{ student.value.percent_proficient_advanced ? student.value.percent_proficient_advanced + '%' : '' }}</strong>
                        </div>
                    </td>

                    <ng-container *ngFor="let course of all_outcomes | keyvalue">
                        <td *ngFor="let outcome of course.value | keyvalue | sortBy:'asc':'value'" [hidden]="!all_outcomes[course.key][outcome.key].has_assessments && !showUnassessed">
                            <div *ngIf="student.value.courses[course.key]" class="d-flex  align-items-center justify-content-center">
                                <ng-container *ngIf="student.value.courses[course.key].outcome_results && student.value.courses[course.key].outcome_results[outcome.key]">
                                    <div *ngFor="let assessment of student.value.courses[course.key].outcome_results[outcome.key].results | sortBy:'asc':'dueAt' | slice:0:3">
                                        <div *ngIf="assessment"
                                            role="button"
                                            (click)="assignmentModalService.openAssignment(student.key, course.key, assessment.assignment_id)"
                                            container="body">
                                            <!-- [title]="(dataService.getAssignment(course.key, student.key, assessment.assignment_id) | async).name" -->
                                            <app-rubric-badge [points]="assessment.points" [skinny]="true"></app-rubric-badge>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </td>
                    </ng-container>

                </tr>
            </tbody>
        </table>
    </div>

</div>